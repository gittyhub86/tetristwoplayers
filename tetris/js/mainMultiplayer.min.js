"use strict";var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var Tetris=function(){function e(t,r){_classCallCheck(this,e),this.element=t,this.tetrises=r,this.canvas=t.querySelector(".tetris"),this.ctx=this.canvas.getContext("2d"),this.ctx.fillStyle="#000",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.scale(20,20),this.ctx.lineWidth=.02,this.area=new Area(12,20),this.canvasPreview=t.querySelector(".preview"),this.ctx2=this.canvasPreview.getContext("2d"),this.ctx2.fillStyle="purple",this.ctx2.fillRect(0,0,this.canvasPreview.width,this.canvasPreview.height),this.ctx2.scale(12,12),this.preview=new Preview(5,5),this.player=new Player(this),this.scoreEl=this.element.querySelector(".score"),this.levelEl=this.element.querySelector(".level"),this.linesEl=this.element.querySelector(".lines"),this.pickLevelEl=t.querySelector(".pick-level > input"),this.levelError=t.querySelector(".level-error"),this.linesEl=t.querySelector(".lines"),this.winnerEl=document.querySelector(".winner"),this.pickLevelEl.value=0,this.requestId,this.lastTime=0,this.dropCounter=0,this.dropInterval=1e3,this.colors=[[null,"#3877FF","yellow","orange","blue","cyan","lime","red"],[null,"brown","#6666ff","#3877FF","#00CC00","maroon","#254117","teal"],[null,"orange","cyan","yellow","magenta","red","blue","lime"],[null,"cyan","yellow","orange","blue","red","magenta","lime"],[null,"yellow","orange","magenta","#3877FF","cyan","lime","red"],[null,"lime","blue","magenta","yellow","red","cyan","orange"],[null,"olive","blue","magenta","orange","red","lime","cyan"],[null,"lime","blue","magenta","orange","cyan","green","maroon"],[null,"#FF0D72","#0DC2FF","#0DFF72","#F538FF","#FF8E0D","#FFE138","#3877FF"],[null,"#003366","#99FFFF","#66FFFF","#33FFFF","#00FFFF","#00CCCC","#009999"],[null,"#003366","#99CCFF","#66B2FF","#3399FF","#0080FF","#0066CC","#004C99"]],this.pointSys=[[40,100,300,1200],[80,200,600,2400],[120,300,900,3600],[120,300,900,3600],[120,300,900,3600],[120,300,900,3600],[120,300,900,3600],[120,300,900,3600],[120,300,900,3600],[400,1e3,3e3,12e3]],this.levelUp=[5,10,15,20,25,30,35,40,45,50]}return _createClass(e,[{key:"center",value:function(){var e=(this.preview.arena.length/2|0)-(this.player.previewPiece.length/2|0);return{x:(this.preview.arena[0].length/2|0)-(this.player.previewPiece[0].length/2|0),y:e}}},{key:"centerX",value:function(){return(this.area.arena[0].length/2|0)-(this.player.piece[0].length/2|0)}},{key:"checkLevelUp",value:function(){this.player.level<10&&(this.player.totLines>=this.levelUp[this.player.level]?(this.player.level++,this.levelEl.innerText="Level: "+this.player.level,this.player.totLines=0,this.linesEl.innerText="Lines: "+this.levelUp[this.player.level]):this.linesEl.innerText="Lines: "+(this.levelUp[this.player.level]-this.player.totLines))}},{key:"drawMatrix",value:function(e,t){var r=this;e.forEach(function(e,i){e.forEach(function(e,n){0!==e&&(r.ctx.fillStyle=r.colors[r.player.level][e],r.ctx.fillRect(n+t.x,i+t.y,1,1),r.ctx.strokeRect(n+t.x,i+t.y,1,1))})})}},{key:"drawPreview",value:function(e,t){var r=this;e.forEach(function(e,i){e.forEach(function(e,n){0!==e&&(r.ctx2.fillStyle=r.colors[r.player.level][e],r.ctx2.fillRect(n+t.x,i+t.y,1,1))})})}},{key:"draw",value:function(){this.ctx.fillStyle="#000",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.drawMatrix(this.area.arena,{x:0,y:0}),this.drawMatrix(this.player.piece,this.player.pos)}},{key:"randomPiece",value:function(){var e="TOLJISZ",t=e[Math.floor(Math.random()*e.length)];return[this.player.createPiece(t),t]}},{key:"init",value:function(){this.area.clear(),this.preview.clear(),this.ctx2.fillStyle="purple",this.ctx2.fillRect(0,0,this.canvasPreview.width,this.canvasPreview.height),this.player.score=0,this.updateScore(this.player.score),this.player.piece=null,this.player.previewPiece=null,this.player.setPiece(),this.player.pos.y=0,this.player.pos.x=this.centerX(),this.drawPreview(this.player.previewPiece,this.center()),this.linesEl.innerText="Lines: 0",this.player.level<10?this.linesEl.innerText="Lines: "+this.levelUp[this.player.level]:this.linesEl.innerText="Lines: Max Level",this.levelEl.innerText="Level: "+this.player.level,this.tetrises&&this.winnerEl.setAttribute("style","display: none"),this.update()}},{key:"printWinner",value:function(){var e=this.tetrises[0],t=this.tetrises[1];e.player.gameOver&&t.player.gameOver&&(this.winnerEl.setAttribute("style","display: block"),e.player.score>t.player.score?this.winnerEl.innerText="Player 1 wins!":e.player.score<t.player.score?this.winnerEl.innerText="Player 2 wins!":this.winnerEl.innerText="Tie game!")}},{key:"reset",value:function(){this.player.setPiece(),this.ctx2.fillStyle="purple",this.ctx2.fillRect(0,0,this.canvasPreview.width,this.canvasPreview.height),this.player.pos.y=0,this.player.pos.x=this.centerX(),this.preview.clear(),this.drawPreview(this.player.previewPiece,this.center()),this.area.collide(this.player)&&(this.player.gameOver=!0,this.tetrises&&this.printWinner())}},{key:"update",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(this.player.gameOver)this.requestId&&(this.draw(),window.cancelAnimationFrame(this.requestId),this.requestId=void 0);else{var t=e-this.lastTime;this.lastTime=e,this.player.update(t),this.draw(),this.requestId=requestAnimationFrame(this.update.bind(this))}}},{key:"updateScore",value:function(e){this.scoreEl.innerText="Score: "+e}}]),e}(),_slicedToArray=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],i=!0,n=!1,s=void 0;try{for(var a,l=e[Symbol.iterator]();!(i=(a=l.next()).done)&&(r.push(a.value),!t||r.length!==t);i=!0);}catch(e){n=!0,s=e}finally{try{!i&&l.return&&l.return()}finally{if(n)throw s}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();_createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var Player=function(){function e(t){_classCallCheck(this,e),this.tetris=t,this.area=this.tetris.area,this.piece,this.previewPiece,this.previewCode,this.pos={x:0,y:0},this.dropCounter=0,this.dropInterval=[1e3,900,800,700,600,500,400,300,200,100,60],this.score=0,this.level=0,this.totLines=0,this.level=0,this.gameOver=!0,this.paused=!1}return _createClass(e,[{key:"createPiece",value:function(e){switch(e){case"T":return[[0,1,0],[1,1,1],[0,0,0]];case"O":return[[2,2],[2,2]];case"L":return[[0,0,3],[3,3,3],[0,0,0]];case"J":return[[4,0,0],[4,4,4],[0,0,0]];case"I":return[[0,5,0,0],[0,5,0,0],[0,5,0,0],[0,5,0,0]];case"S":return[[0,6,6],[6,6,0],[0,0,0]];case"Z":return[[7,7,0],[0,7,7],[0,0,0]]}}},{key:"drop",value:function(){this.pos.y++,this.area.collide(this)&&this.postCollide(),this.dropCounter=0}},{key:"dropFast",value:function(){for(;this.pos.y<=this.area.arena.length;){if(this.area.collide(this))return void this.postCollide();this.pos.y++}}},{key:"move",value:function(e){this.pos.x+=e,this.area.collide(this)&&(this.pos.x-=e)}},{key:"pause",value:function(){this.tetris.requestId&&(window.cancelAnimationFrame(this.tetris.requestId),this.tetris.requestId=void 0,this.paused=!0)}},{key:"postCollide",value:function(){this.pos.y--,this.area.merge(this),this.tetris.reset(),this.area.sweep(this,this.tetris),this.tetris.updateScore(this.score)}},{key:"rotate",value:function(e){for(this.rotateMatrix(e);this.area.collide(this);)return void this.rotate(-e)}},{key:"rotateMatrix",value:function(e){for(var t=0;t<this.piece.length;t++)for(var r=0;r<t;r++){var i=[this.piece[t][r],this.piece[r][t]];this.piece[r][t]=i[0],this.piece[t][r]=i[1]}e>0?this.piece.forEach(function(e){return e.reverse()}):this.piece.reverse()}},{key:"setPiece",value:function(){if(this.piece||this.previewPiece){if(this.previewPiece){this.piece=this.previewPiece;var e=this.tetris.randomPiece(),t=_slicedToArray(e,2);this.previewPiece=t[0],this.previewCode=t[1]}}else{this.piece=this.tetris.randomPiece()[0];var r=this.tetris.randomPiece(),i=_slicedToArray(r,2);this.previewPiece=i[0],this.previewCode=i[1]}}},{key:"getLevel",value:function(){var e=this.tetris.pickLevelEl.value;return parseInt(e.replace(/(<([^>]+)>)/gi,""))}},{key:"start",value:function(e){this.level=e,this.gameOver=!1,this.tetris.levelError.classList="level-error hide",this.tetris.pickLevelEl.blur(),this.tetris.init()}},{key:"unPause",value:function(){this.tetris.update(),this.paused=!1}},{key:"update",value:function(e){this.dropCounter+=e,this.level>10&&this.dropCounter>60?this.drop():this.dropCounter>this.dropInterval[this.level]&&this.drop()}}]),e}();_createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var Rect=function(){function e(t,r){_classCallCheck(this,e),this.arena=this.createMatrix(t,r)}return _createClass(e,[{key:"clear",value:function(){this.arena.forEach(function(e){return e.fill(0)})}},{key:"createMatrix",value:function(e,t){for(var r=[];t--;)r.push(new Array(e).fill(0));return r}}]),e}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var Preview=function(e){function t(e,r){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r))}return _inherits(t,Rect),t}();_createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var Area=function(e){function t(e,r){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r))}return _inherits(t,Rect),_createClass(t,[{key:"collide",value:function(e){for(var t=[e.piece,e.pos],r=t[0],i=t[1],n=0;n<r.length;n++)for(var s=0;s<r[n].length;s++)if(0!==r[n][s]&&0!==(this.arena[n+i.y]&&this.arena[n+i.y][s+i.x]))return!0;return!1}},{key:"merge",value:function(e){var t=this;e.piece.forEach(function(r,i){r.forEach(function(r,n){0!==r&&(t.arena[i+e.pos.y][n+e.pos.x]=r)})})}},{key:"sweep",value:function(e,t){var r=0;e:for(var i=this.arena.length-1;i>0;i--){for(var n=0;n<this.arena[i].length;n++)if(0===this.arena[i][n])continue e;var s=this.arena.splice(i,1)[0].fill(0);this.arena.unshift(s),i++,r++}r>0&&(e.level<10?e.score+=t.pointSys[e.level][r-1]:(e.score+=t.pointSys[0][r-1]*(e.level+1),t.updateScore(e.score)),e.totLines+=r,t.checkLevelUp())}}]),t}(),tetrises=[],playerElements=document.querySelectorAll(".player");playerElements.forEach(function(e){tetrises.push(new Tetris(e,tetrises))});var playerOne=tetrises[0].player,playerTwo=tetrises[1].player;function activeMenu(){var e=document.querySelectorAll(".nav__item");e.forEach(function(t){var r=window.location.pathname;r.match(/.*\/$/)||r.match(/.*\/index.html$/)?e[0].classList.add("active"):r.match(/multiplayer/)&&e[1].classList.add("active")})}var keyListener=function(e){var t=playerOne.getLevel(),r=playerTwo.getLevel();[[65,83,90,81,87,54,88],[75,76,188,73,79,55,190]].forEach(function(i,n){var s=tetrises[n].player,a=s.getLevel();if(playerOne.gameOver&&playerTwo.gameOver&&84===e.keyCode){if(t>=0&&t<11&&r>=0&&r<11)return playerOne.start(t),void playerTwo.start(r);tetrises[n].levelError.className=a>=0&&a>10||a<0?"level-error visible":"level-error hide"}else{if(s.gameOver)return;s.paused||e.repeat?s.paused&&e.keyCode===i[5]&&s.unPause():e.keyCode===i[0]?s.move(-1):e.keyCode===i[1]?s.move(1):e.keyCode===i[2]?s.drop():e.keyCode===i[3]?s.rotate(1):e.keyCode===i[4]?s.rotate(-1):e.keyCode===i[5]?s.pause():e.keyCode===i[6]&&s.dropFast()}})};document.addEventListener("keydown",keyListener),activeMenu();var menu=document.querySelector("#menu"),main=document.querySelector(".main"),drawer=document.querySelector(".nav");menu.addEventListener("click",function(e){drawer.classList.toggle("open"),e.stopPropagation()}),main.addEventListener("click",function(){drawer.classList.remove("open")});